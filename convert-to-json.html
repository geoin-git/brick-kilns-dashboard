<!DOCTYPE html>
<html>
<head>
    <title>Convert Google Sheets CSV to JSON</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        textarea { width: 100%; height: 200px; font-family: monospace; }
        button { padding: 10px 20px; margin: 10px 0; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f5f5f5; padding: 15px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>CSV to JSON Converter</h1>
    <p>Paste your CSV data from Google Sheets below and click Convert:</p>
    
    <textarea id="csvInput" placeholder="Paste CSV data here..."></textarea>
    <br>
    <button onclick="convertCSV()">Convert to JSON</button>
    <button onclick="downloadJSON()">Download JSON</button>
    
    <h2>Output:</h2>
    <pre id="output"></pre>

    <script>
        let jsonData = [];

        function convertCSV() {
            const csv = document.getElementById('csvInput').value.trim();
            if (!csv) {
                alert('Please paste CSV data first');
                return;
            }

            const lines = csv.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('Invalid CSV format');
                return;
            }

            // Find header
            let headerIndex = -1;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].toLowerCase();
                if (line.includes('name') && line.includes('latitude')) {
                    headerIndex = i;
                    break;
                }
            }

            if (headerIndex === -1) {
                alert('Header row not found');
                return;
            }

            const headers = lines[headerIndex].toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
            const colIndex = {
                name: headers.indexOf('name'),
                lat: headers.indexOf('latitude'),
                lng: headers.indexOf('longitude'),
                dateCTO: headers.indexOf('date_of_cto'),
                validity: headers.indexOf('validity')
            };

            if (colIndex.name === -1 || colIndex.lat === -1 || colIndex.lng === -1) {
                alert('Required columns not found');
                return;
            }

            const kilns = [];
            const dataLines = lines.slice(headerIndex + 1);

            for (let i = 0; i < dataLines.length; i++) {
                const line = dataLines[i].trim();
                if (!line) continue;

                // Parse CSV row
                const row = [];
                let current = '';
                let inQuotes = false;

                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim().replace(/^"|"$/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                row.push(current.trim().replace(/^"|"$/g, ''));

                const latValue = parseFloat(row[colIndex.lat]);
                const lngValue = parseFloat(row[colIndex.lng]);

                if (isNaN(latValue) || isNaN(lngValue)) {
                    continue;
                }

                // Swap coordinates (CSV has them reversed)
                const lat = lngValue;
                const lng = latValue;

                kilns.push({
                    name: row[colIndex.name] || 'Unnamed',
                    lat: lat,
                    lng: lng,
                    dateCTO: row[colIndex.dateCTO] || '',
                    validity: row[colIndex.validity] || ''
                });
            }

            jsonData = kilns;
            document.getElementById('output').textContent = JSON.stringify(kilns, null, 2);
        }

        function downloadJSON() {
            if (jsonData.length === 0) {
                alert('Please convert CSV first');
                return;
            }

            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'kilns.json';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

